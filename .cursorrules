# Dese EA Plan v6.8.1 - Cursor AI Rules

> **GeÃ§erlilik:** Bu kurallar Dese EA Plan v6.8.1 projesi iÃ§in geÃ§erlidir  
> **Versiyon:** 6.8.1  
> **Son GÃ¼ncelleme:** 2025-11-09  
> **Uyumluluk:** Cursor AI v2.0+, TypeScript 5.3+, Node.js 20.19+

---

## ğŸ¯ ODAKLANMA REHBERÄ° - Ã–NEMLÄ°!

> **KullanÄ±cÄ± dikkat daÄŸÄ±nÄ±klÄ±ÄŸÄ± sorunu yaÅŸÄ±yor. Bu yÃ¼zden:**

1. **TEK GÃ–REV ODAKLI Ã‡ALIÅ**: Her seferinde sadece bir gÃ¶rev Ã¼zerinde Ã§alÄ±ÅŸ
2. **NET HEDEFLER**: Her gÃ¶rev iÃ§in net bir sonuÃ§ tanÄ±mla
3. **Ä°LERLEME TAKÄ°BÄ°**: Tamamlanan gÃ¶revleri iÅŸaretle
4. **GEREKSÄ°Z DOSYALAR**: Eski/geÃ§ersiz dosyalarÄ± sil, temiz tut
5. **Ã–NCELÄ°K SIRASI**: Her zaman Ã¶ncelik sÄ±rasÄ±na gÃ¶re Ã§alÄ±ÅŸ

### Åu Anki Aktif GÃ¶rev

**Kyverno Stabilizasyonu & MCP Fazâ€¯1 Revizyonu**
- Ã–ncelik: ğŸ”´ YÃ¼ksek
- SÃ¼re: 1 gÃ¼n (09-10 KasÄ±m 2025)
- Durum: ğŸ”„ Kyverno/ArgoCD dÃ¼zeltmeleri tamamlandÄ±, dokÃ¼mantasyon & hafÄ±za revizyonu devam ediyor

**Referanslar:** `GUNCELLEME_OZETI_v6.8.1.md`, `MCP_KAPSAMLI_ANALIZ_VE_PLAN.md`

---

## ğŸ¯ Proje Ã–zeti

Dese EA Plan v6.8.1 - CPT Optimization Domain iÃ§in Kubernetes + GitOps + AIOps uyumlu kurumsal planlama sistemi.

**Tech Stack:**
- **Frontend**: Next.js 16 + React 19 + TypeScript + Tailwind CSS
- **Backend**: Node.js + Express + PostgreSQL (Drizzle ORM)
- **MCP Servers**: 4 adet (FinBot, MuBot, DESE, Observability)
- **Testing**: Vitest + Supertest + Playwright
- **Package Manager**: pnpm 8.15.0
- **Infrastructure**: Docker + Kubernetes + Helm + ArgoCD
- **Monitoring**: Prometheus + Grafana + Loki + Tempo

---

## ğŸ¤– AI AsistanÄ± iÃ§in Ã–zel Direktifler

> **Ã–NEMLÄ°:** Cursor AI asistanÄ± kod Ã¶nerirken ve Ã¼retirken **MUTLAKA** aÅŸaÄŸÄ±daki kurallara uymalÄ±dÄ±r:

### Zorunlu Kurallar

1. **Path Aliases**: **HER ZAMAN** `@/` prefix'ini kullanÄ±n
   - âœ… `import { config } from '@/config/index.js'`
   - âŒ `import { config } from '../../config/index.js'`

2. **Type Safety**: **ASLA** `any` tipi Ã¶nermeyin
   - âœ… `function getUser(id: string): Promise<User | null>`
   - âŒ `function getUser(id: any)`

3. **Logging**: **ASLA** `console.log` Ã¶nermeyin, **HER ZAMAN** `logger` kullanÄ±n
   - âœ… `logger.info('User created', { userId: user.id })`
   - âŒ `console.log('User created:', user)`

4. **Error Handling**: **HER async fonksiyonda** try-catch kullanÄ±n
   - âœ… Always wrap async operations in try-catch
   - âŒ Never leave promises unhandled

5. **Database Queries**: **ASLA** raw SQL Ã¶nermeyin, **HER ZAMAN** Drizzle ORM kullanÄ±n
   - âœ… `db.query.users.findFirst({ where: eq(users.id, id) })`
   - âŒ `db.query('SELECT * FROM users WHERE id = ?')`

6. **MCP Server Rules**: MCP server'lar iÃ§in Ã¶zel kurallar
   - âœ… Her MCP server authentication yapmalÄ±
   - âœ… GerÃ§ek backend API'lerine baÄŸlanmalÄ± (mock data deÄŸil)
   - âœ… Error handling ve logging zorunlu
   - âœ… Redis cache kullanÄ±lmalÄ±

---

## ğŸ“ MCP Server KurallarÄ±

### MCP Server YapÄ±sÄ±

**4 Adet MCP Server:**
1. **FinBot MCP** (Port 5555) - `/finbot`
2. **MuBot MCP** (Port 5556) - `/mubot`
3. **DESE MCP** (Port 5557) - `/dese`
4. **Observability MCP** (Port 5558) - `/observability`

### MCP Server Kod StandartlarÄ±

```typescript
// âœ… DoÄŸru MCP Server YapÄ±sÄ±
import express, { Request, Response } from 'express';
import { logger } from '@/utils/logger.js';
import { authenticate } from '@/middleware/auth.js';
import { withAuth } from '@/rbac/decorators.js';
import { redis } from '@/services/storage/redisClient.js';
import { asyncHandler } from '@/middleware/errorHandler.js';

const app = express();
const PORT = 5555; // Environment variable'dan alÄ±nmalÄ±

app.use(express.json());
app.use(authenticate); // Authentication zorunlu

// Health check endpoint
app.get('/finbot/health', async (req: Request, res: Response) => {
  res.json({
    status: 'healthy',
    service: 'finbot-mcp',
    version: '1.0.0',
    timestamp: new Date().toISOString(),
  });
});

// Query endpoint (cache ile)
app.post('/finbot/query',
  ...withAuth('mcp.finbot.query', 'read'),
  asyncHandler(async (req: Request, res: Response) => {
    const { query, context } = req.body;
    
    // Cache kontrolÃ¼
    const cacheKey = `mcp:finbot:query:${JSON.stringify(req.body)}`;
    const cached = await redis.get(cacheKey);
    if (cached) {
      return res.json(JSON.parse(cached));
    }
    
    // GerÃ§ek API Ã§aÄŸrÄ±sÄ± (mock deÄŸil!)
    const finbotResponse = await fetch(`${FINBOT_BASE}/api/v1/accounts`);
    const accounts = await finbotResponse.json();
    
    const result = {
      query,
      response: {
        module: 'finbot',
        context: { accounts },
      },
    };
    
    // Cache'e kaydet (60 saniye TTL)
    await redis.setex(cacheKey, 60, JSON.stringify(result));
    
    logger.info('MCP query processed', { module: 'finbot', query });
    res.json(result);
  })
);

// Error handler
app.use(errorHandler);
```

**MCP Server KurallarÄ±:**
- âœ… Authentication middleware zorunlu
- âœ… RBAC permission check zorunlu
- âœ… GerÃ§ek backend API Ã§aÄŸrÄ±larÄ± (mock data deÄŸil)
- âœ… Redis cache kullanÄ±mÄ±
- âœ… Error handling middleware
- âœ… Structured logging
- âœ… Environment variable'dan port alÄ±nmalÄ±

---

## ğŸ“ Dosya YapÄ±sÄ± KurallarÄ±

AI asistanÄ± yeni dosya oluÅŸtururken ÅŸu yapÄ±yÄ± izlemelidir:

- `src/routes/**/*.ts` â†’ Route handlers (Express Router)
- `src/services/**/*.ts` â†’ Business logic
- `src/middleware/**/*.ts` â†’ Express middleware
- `src/mcp/**/*.ts` â†’ MCP Server implementations
- `src/db/**/*.ts` â†’ Database schema & connection
- `src/utils/**/*.ts` â†’ Utility functions
- `src/schemas/**/*.ts` â†’ Zod validation schemas

---

## ğŸ“ Dosya/Glob BazlÄ± Kurallar

### `src/routes/**/*.ts`

```typescript
// âœ… DoÄŸru Route YapÄ±sÄ±
import { Router } from 'express';
import { z } from 'zod';
import { logger } from '@/utils/logger.js';
import { exampleService } from '@/services/exampleService.js';
import { asyncHandler } from '@/middleware/errorHandler.js';

const router = Router();

const createSchema = z.object({
  name: z.string().min(1),
  email: z.string().email(),
});

router.post('/', asyncHandler(async (req, res) => {
  const validated = createSchema.parse(req.body);
  const result = await exampleService.create(validated);
  logger.info('Resource created', { id: result.id });
  res.status(201).json(result);
}));

export { router as exampleRoutes };
```

**Kurallar:**
- âœ… Router export edilmeli
- âœ… Zod validation ÅŸemasÄ± tanÄ±mlÄ±
- âœ… Service katmanÄ± kullanÄ±lmalÄ± (direct DB access âŒ)
- âœ… Swagger annotations eklenmeli
- âœ… asyncHandler kullanÄ±lmalÄ±

### `src/services/**/*.ts`

```typescript
// âœ… DoÄŸru Service YapÄ±sÄ±
import { db } from '@/db/index.js';
import { users } from '@/db/schema.js';
import { eq } from 'drizzle-orm';
import { logger } from '@/utils/logger.js';

export const userService = {
  async findById(id: string): Promise<User | null> {
    try {
      const user = await db.query.users.findFirst({
        where: eq(users.id, id),
      });
      return user ?? null;
    } catch (error) {
      logger.error('Failed to find user', { id, error });
      throw error;
    }
  },
};
```

**Kurallar:**
- âœ… Business logic burada olmalÄ±
- âœ… Drizzle ORM kullanÄ±lmalÄ±
- âœ… Error handling ve logging zorunlu
- âœ… Type safety saÄŸlanmalÄ±

### `src/mcp/**/*.ts` (MCP Servers)

```typescript
// âœ… DoÄŸru MCP Server YapÄ±sÄ±
import express from 'express';
import { logger } from '@/utils/logger.js';
import { authenticate } from '@/middleware/auth.js';
import { redis } from '@/services/storage/redisClient.js';

const app = express();
app.use(express.json());
app.use(authenticate); // Zorunlu!

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', service: 'mcp-server' });
});

// Query endpoint (cache + real API)
app.post('/query', async (req, res) => {
  const cacheKey = `mcp:query:${JSON.stringify(req.body)}`;
  const cached = await redis.get(cacheKey);
  if (cached) return res.json(JSON.parse(cached));
  
  // GerÃ§ek API Ã§aÄŸrÄ±sÄ±
  const result = await fetch(`${BACKEND_API}/endpoint`);
  await redis.setex(cacheKey, 60, JSON.stringify(result));
  res.json(result);
});

export default app;
```

**MCP Server KurallarÄ±:**
- âœ… Authentication middleware zorunlu
- âœ… RBAC permission check
- âœ… Redis cache kullanÄ±mÄ±
- âœ… GerÃ§ek backend API Ã§aÄŸrÄ±larÄ±
- âœ… Error handling
- âœ… Structured logging

---

## ğŸ¨ Frontend KurallarÄ± (Next.js 16 + React 19)

### Component YapÄ±sÄ±

```typescript
// âœ… DoÄŸru Component YapÄ±sÄ±
'use client';

import { FC } from 'react';

interface UserCardProps {
  id: string;
  name: string;
  email: string;
  onEdit?: (id: string) => void;
}

export const UserCard: FC<UserCardProps> = ({ id, name, email, onEdit }) => {
  return (
    <div className="p-4 bg-white rounded-lg shadow">
      <h3 className="text-lg font-semibold">{name}</h3>
      <p className="text-gray-600">{email}</p>
      {onEdit && (
        <button onClick={() => onEdit(id)}>Edit</button>
      )}
    </div>
  );
};
```

**Kurallar:**
- âœ… TypeScript interface kullanÄ±lmalÄ± (props iÃ§in)
- âœ… Functional components tercih edilmeli
- âœ… Tailwind CSS class'larÄ± kullanÄ±lmalÄ±
- âœ… Props optional ise `?` ile iÅŸaretlenmeli
- âœ… 'use client' directive gerekli yerlerde

---

## ğŸ”§ Backend KurallarÄ± (Node.js + Express)

### API Endpoint YapÄ±sÄ±

```typescript
// âœ… DoÄŸru Endpoint YapÄ±sÄ±
import { Router } from 'express';
import { z } from 'zod';
import { logger } from '@/utils/logger.js';
import { exampleService } from '@/services/exampleService.js';
import { asyncHandler } from '@/middleware/errorHandler.js';
import { withAuth } from '@/rbac/decorators.js';

const router = Router();

const createExampleSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  value: z.number().positive('Value must be positive'),
});

/**
 * @swagger
 * /api/v1/example:
 *   post:
 *     summary: Create a new example
 */
router.post('/',
  ...withAuth('example.create', 'write'),
  asyncHandler(async (req, res) => {
    const validated = createExampleSchema.parse(req.body);
    const result = await exampleService.create(validated);
    
    logger.info('Example created', { 
      id: result.id,
      name: validated.name,
    });
    
    res.status(201).json(result);
  })
);

export { router as exampleRoutes };
```

---

## ğŸ§ª Testing KurallarÄ±

### Unit Test YapÄ±sÄ±

```typescript
// âœ… DoÄŸru Test YapÄ±sÄ±
import { describe, it, expect, beforeEach } from 'vitest';
import { userService } from '@/services/userService.js';

describe('userService', () => {
  describe('findById', () => {
    it('should return user when user exists', async () => {
      // Arrange
      const userId = '123';
      
      // Act
      const user = await userService.findById(userId);
      
      // Assert
      expect(user).toBeDefined();
      expect(user?.id).toBe(userId);
    });
  });
});
```

**Kurallar:**
- âœ… AAA pattern kullanÄ±lmalÄ± (Arrange, Act, Assert)
- âœ… Test naming: `should [expected behavior] when [condition]`
- âœ… Her test case tek bir ÅŸeyi test etmeli
- âœ… Test dosyasÄ± `*.test.ts` formatÄ±nda olmalÄ±

---

## ğŸ”’ Security KurallarÄ±

### Input Validation

```typescript
// âœ… DoÄŸru Validation
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain uppercase letter')
    .regex(/[a-z]/, 'Password must contain lowercase letter')
    .regex(/[0-9]/, 'Password must contain number'),
});

export async function createUser(data: unknown) {
  const validated = createUserSchema.parse(data); // Throws if invalid
  // Process validated data
}
```

### SQL Injection Prevention

```typescript
// âœ… DoÄŸru - Drizzle ORM (Type-safe, SQL injection proof)
import { eq } from 'drizzle-orm';

const user = await db.query.users.findFirst({
  where: eq(users.id, userId),
});

// âŒ YANLIÅ - Raw SQL (NEVER DO THIS)
// const user = await db.query(`SELECT * FROM users WHERE id = '${userId}'`);
```

---

## ğŸ“Š Logging KurallarÄ±

### Structured Logging

```typescript
// âœ… DoÄŸru Logging
logger.info('User created', {
  userId: user.id,
  email: user.email,
  timestamp: new Date().toISOString(),
  action: 'create_user',
});

logger.error('Failed to process payment', {
  orderId,
  userId,
  error: error.message,
  stack: error.stack,
  context: { amount, currency },
});

// âŒ YANLIÅ
console.log('User created:', user); // âŒ Never use console.log
console.error('Error:', error);     // âŒ Never use console.error
```

**Kurallar:**
- âœ… Structured logging (JSON format)
- âœ… Context bilgisi eklenmeli
- âœ… Sensitive data log'lanmamalÄ±
- âœ… Log levels: `debug`, `info`, `warn`, `error`

---

## ğŸš€ Performance KurallarÄ±

### Async Operations

```typescript
// âœ… DoÄŸru - Parallel execution
const [users, posts, comments] = await Promise.all([
  getUserById(id),
  getPostsByUserId(id),
  getCommentsByUserId(id),
]);

// âŒ YANLIÅ - Sequential execution
const users = await getUserById(id);      // âŒ Slow
const posts = await getPostsByUserId(id); // âŒ Slow
const comments = await getCommentsByUserId(id); // âŒ Slow
```

### Database Optimization

```typescript
// âœ… DoÄŸru - Select only needed fields
const projects = await db.query.seoProjects.findMany({
  where: eq(seoProjects.status, 'active'),
  columns: {
    id: true,
    name: true,
    domain: true,
  },
  limit: 100,
});

// âŒ YANLIÅ - Select all fields
const projects = await db.query.seoProjects.findMany(); // âŒ Too much data
```

---

## ğŸ—‚ï¸ Dosya Organizasyonu KurallarÄ±

```
src/
â”œâ”€â”€ config/          # Configuration files
â”œâ”€â”€ db/              # Database
â”œâ”€â”€ middleware/      # Express middleware
â”œâ”€â”€ routes/          # API routes
â”œâ”€â”€ services/        # Business logic
â”œâ”€â”€ mcp/             # MCP Servers (4 adet)
â”œâ”€â”€ schemas/         # Zod validation
â””â”€â”€ utils/           # Utilities
```

**Kurallar:**
- âœ… Her klasÃ¶rÃ¼n tek bir sorumluluÄŸu olmalÄ±
- âœ… Services â†’ Business logic
- âœ… Routes â†’ HTTP handlers
- âœ… MCP â†’ Model Context Protocol servers
- âœ… Middleware â†’ Cross-cutting concerns
- âœ… Utils â†’ Reusable helpers

---

## âœ… YAPILMASI GEREKENLER

### TypeScript
- âœ… Her zaman explicit types kullanÄ±n
- âœ… Null safety iÃ§in null checks yapÄ±n
- âœ… Path aliases (`@/`) kullanÄ±n
- âœ… File extensions ekleyin (`.js`)
- âœ… Generic types'Ä± uygun yerlerde kullanÄ±n

### Error Handling
- âœ… Her async fonksiyon iÃ§in try-catch
- âœ… asyncHandler middleware kullanÄ±n
- âœ… Ã–zel error class'larÄ± kullanÄ±n
- âœ… Error'larÄ± log'layÄ±n
- âœ… User-friendly messages, detaylarÄ± log'da

### Validation
- âœ… Zod schemas kullanÄ±n
- âœ… API endpoints'de validation
- âœ… Drizzle ORM kullanÄ±n (SQL injection korumasÄ±)

### Logging
- âœ… Structured logging (logger utility)
- âœ… Context bilgisi ekleyin
- âœ… Sensitive data log'lamayÄ±n

### Testing
- âœ… Her feature iÃ§in unit test
- âœ… Test coverage %70+ (hedef %80+)
- âœ… Integration testler iÃ§in testcontainers
- âœ… AAA pattern kullanÄ±n

### MCP Servers
- âœ… Authentication middleware zorunlu
- âœ… RBAC permission check
- âœ… GerÃ§ek backend API entegrasyonu (mock deÄŸil)
- âœ… Redis cache kullanÄ±mÄ±
- âœ… Error handling ve logging

---

## âŒ YAPILMAMASI GEREKENLER

1. âŒ **`any` type kullanmayÄ±n** - Her zaman explicit types
2. âŒ **`console.log` kullanmayÄ±n** - Logger utility kullanÄ±n
3. âŒ **Raw SQL queries** - Drizzle ORM kullanÄ±n
4. âŒ **Hardcoded secrets** - Environment variables
5. âŒ **Main branch'e direkt commit** - PR aÃ§Ä±n
6. âŒ **BÃ¼yÃ¼k PR'lar** (1000+ satÄ±r) - KÃ¼Ã§Ã¼k, odaklanmÄ±ÅŸ PR'lar
7. âŒ **Test yazmadan PR** - Her feature iÃ§in test
8. âŒ **Relative imports** (`../../`) - Path aliases kullanÄ±n
9. âŒ **Synchronous DB operations** - async/await kullanÄ±n
10. âŒ **Unhandled promises** - Her zaman handle edin
11. âŒ **MCP server'larda mock data** - GerÃ§ek API Ã§aÄŸrÄ±larÄ± kullanÄ±n
12. âŒ **MCP server'larda authentication eksik** - Her zaman auth ekleyin

---

## ğŸ” Kod Review Checklist

PR aÃ§madan Ã¶nce kontrol edin:

- [ ] TypeScript types tanÄ±mlÄ± (no `any`)
- [ ] Linting geÃ§iyor (`pnpm lint`)
- [ ] Tests geÃ§iyor (`pnpm test`)
- [ ] Test coverage %70+ (`pnpm test:coverage`)
- [ ] Error handling var (try-catch veya asyncHandler)
- [ ] Input validation yapÄ±ldÄ± (Zod)
- [ ] Logging eklendi (logger, not console)
- [ ] DokÃ¼mantasyon gÃ¼ncellendi (README, JSDoc)
- [ ] Security kontrolÃ¼ yapÄ±ldÄ±
- [ ] No hardcoded secrets
- [ ] Path aliases kullanÄ±ldÄ± (`@/`)
- [ ] Drizzle ORM kullanÄ±ldÄ± (no raw SQL)
- [ ] MCP server'larda authentication var
- [ ] MCP server'larda gerÃ§ek API Ã§aÄŸrÄ±larÄ± var

---

## ğŸ“š Referans DokÃ¼mantasyon

### Ã–nemli Dosyalar (Odaklanma Ä°Ã§in)

1. **`MCP_KAPSAMLI_ANALIZ_VE_PLAN.md`** - MCP analiz ve planlar (ÅU ANKÄ° AKTÄ°F GÃ–REV)
2. **`DESE_JARVIS_CONTEXT.md`** - Proje context bilgileri
3. **`docs/SPRINT_2.6_DAY_3_SUMMARY.md`** - Sprint 2.6 GÃ¼n 3 Ã¶zeti
4. **`README.md`** - Proje dokÃ¼mantasyonu
5. **`CODING_STANDARDS.md`** - DetaylÄ± kod standartlarÄ±

### DiÄŸer Referanslar
- `CONTRIBUTING.md` - KatkÄ±da bulunma rehberi
- `RELEASE_NOTES_v6.8.0.md` - Release notlarÄ±

---

## ğŸ”„ GÃ¼ncelleme NotlarÄ±

### v6.8.0 (2025-01-27)
- âœ… MCP Server kurallarÄ± eklendi
- âœ… Odaklanma rehberi eklendi
- âœ… Åu anki aktif gÃ¶rev belirtildi
- âœ… Authentication ve cache kurallarÄ± eklendi
- âœ… GerÃ§ek API entegrasyonu kurallarÄ± eklendi

---

**Son GÃ¼ncelleme:** 2025-01-27  
**Versiyon:** 6.8.0  
**GeÃ§erlilik:** Dese EA Plan v6.8.0+
