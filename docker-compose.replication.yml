version: '3.8'

services:
  db-primary:
    image: postgres:15
    container_name: db-primary
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dese}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dese123}
      POSTGRES_DB: ${POSTGRES_DB:-dese_ea_plan_v5}
      POSTGRES_REPLICATION_USER: ${POSTGRES_REPLICATION_USER:-replicator}
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD:-replication_password}
    command:
      - "postgres"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "max_wal_senders=3"
      - "-c"
      - "max_replication_slots=3"
      - "-c"
      - "hot_standby=on"
      - "-c"
      - "wal_keep_size=512MB"
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./init-sql/replication-setup.sql:/docker-entrypoint-initdb.d/replication-setup.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dese} -d ${POSTGRES_DB:-dese_ea_plan_v5}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - dese-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  db-replica-1:
    image: postgres:15
    container_name: db-replica-1
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dese}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dese123}
      POSTGRES_MASTER_HOST: db-primary
      POSTGRES_REPLICATION_USER: ${POSTGRES_REPLICATION_USER:-replicator}
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD:-replication_password}
    command:
      - "postgres"
      - "-c"
      - "hot_standby=on"
    volumes:
      - postgres_replica1_data:/var/lib/postgresql/data
      - ./init-sql/replica-setup.sh:/docker-entrypoint-initdb.d/replica-setup.sh:ro
    depends_on:
      db-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dese}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - dese-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: pgbouncer
    environment:
      DATABASES_HOST: db-primary
      DATABASES_PORT: 5432
      DATABASES_USER: ${POSTGRES_USER:-dese}
      DATABASES_PASSWORD: ${POSTGRES_PASSWORD:-dese123}
      DATABASES_DBNAME: ${POSTGRES_DB:-dese_ea_plan_v5}
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 1000
      PGBOUNCER_DEFAULT_POOL_SIZE: 25
      PGBOUNCER_MIN_POOL_SIZE: 5
      PGBOUNCER_RESERVE_POOL_SIZE: 5
      PGBOUNCER_RESERVE_POOL_TIMEOUT: 3
      PGBOUNCER_MAX_DB_CONNECTIONS: 0
      PGBOUNCER_MAX_USER_CONNECTIONS: 0
      PGBOUNCER_STATS_USERS: stats
    volumes:
      - ./config/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
    ports:
      - "6432:6432"
    depends_on:
      - db-primary
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6432", "-U", "pgbouncer"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - dese-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'

networks:
  dese-network:
    driver: bridge

volumes:
  postgres_primary_data:
  postgres_replica1_data:

