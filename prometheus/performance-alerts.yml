groups:
  - name: performance_alerts
    interval: 30s
    rules:
      # API Response Time Alerts
      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API response time detected"
          description: "API p95 response time is {{ $value }}s (threshold: 0.5s) for route {{ $labels.route }}"

      - alert: CriticalAPIResponseTime
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1.0
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Critical API response time detected"
          description: "API p99 response time is {{ $value }}s (threshold: 1.0s) for route {{ $labels.route }}"

      # Database Query Time Alerts
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Slow database queries detected"
          description: "Database query p95 duration is {{ $value }}s (threshold: 0.2s) for table {{ $labels.table }} operation {{ $labels.operation }}"

      - alert: CriticalDatabaseQueries
        expr: histogram_quantile(0.99, rate(database_query_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Critical database query time detected"
          description: "Database query p99 duration is {{ $value }}s (threshold: 0.5s) for table {{ $labels.table }}"

      # Cache Hit Rate Alerts
      - alert: LowCacheHitRate
        expr: |
          (
            rate(cache_hits_total[5m]) / 
            (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m]))
          ) * 100 < 80
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low cache hit rate detected"
          description: "Cache hit rate is {{ $value }}% (threshold: 80%) for prefix {{ $labels.cache_key_prefix }}"

      - alert: CriticalCacheHitRate
        expr: |
          (
            rate(cache_hits_total[5m]) / 
            (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m]))
          ) * 100 < 50
        for: 10m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Critical cache hit rate detected"
          description: "Cache hit rate is {{ $value }}% (threshold: 50%) for prefix {{ $labels.cache_key_prefix }}"

      # Memory Usage Alerts
      - alert: HighMemoryUsage
        expr: process_memory_usage_bytes{type="rss"} > 1073741824 * 2  # 2GB
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage detected"
          description: "Process RSS memory usage is {{ $value | humanize1024 }}B (threshold: 2GB)"

      - alert: CriticalMemoryUsage
        expr: process_memory_usage_bytes{type="rss"} > 1073741824 * 3  # 3GB
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical memory usage detected"
          description: "Process RSS memory usage is {{ $value | humanize1024 }}B (threshold: 3GB)"

      # CPU Usage Alerts
      - alert: HighCPUUsage
        expr: process_cpu_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage detected"
          description: "Process CPU usage is {{ $value }}% (threshold: 85%)"

      - alert: CriticalCPUUsage
        expr: process_cpu_usage_percent > 95
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical CPU usage detected"
          description: "Process CPU usage is {{ $value }}% (threshold: 95%)"

      # Database Connection Pool Alerts
      - alert: DatabasePoolExhausted
        expr: database_pool_size{state="waiting"} > 5
        for: 2m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "{{ $value }} connections are waiting for a database connection"

      - alert: DatabaseConnectionLeak
        expr: database_connections_active > 15
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Potential database connection leak"
          description: "{{ $value }} active database connections (threshold: 15)"

      # Error Rate Alerts
      - alert: HighErrorRate
        expr: |
          (
            rate(http_requests_total{status_code=~"5.."}[5m]) / 
            rate(http_requests_total[5m])
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }}% (threshold: 5%)"

      - alert: CriticalErrorRate
        expr: |
          (
            rate(http_requests_total{status_code=~"5.."}[5m]) / 
            rate(http_requests_total[5m])
          ) * 100 > 10
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value }}% (threshold: 10%)"

